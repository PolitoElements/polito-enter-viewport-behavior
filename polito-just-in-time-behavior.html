<script>
    if (typeof(Polito) != "object") {
        var Polito = {};
    }
    Polito.JustInTimeBehavior = {

        //public stuff
        prepareToRender: function() {},
        properties: {
            everVisible: Boolean,
            attachedToScroll: Boolean,
        },
        // end public stuff

        _onScroll: null,
        _bacameVisible: function() {
            this.everVisible = true;
            if (this.attachedToScroll) {
                window.removeEventListener('scroll', this._setupOnScroll());
                this.attachedToScroll = false;
            }
            this.prepareToRender();
        },
        attached: function() {
            this._setupOnScroll()();
            // cause it to load right away
            if (!this.everVisible) {
                this.attachedToScroll = true;
                this.async(this._setupListeners);
            }
        },
        _setupListeners: function() {
            var polito = this;
            window.addEventListener('scroll', this._setupOnScroll());
        },
        _setupOnScroll: function() {
            var polito = this;
            if (!this._onScroll) {
                this._onScroll = function(e) {
                    var el = polito;

                    var top = el.offsetTop;
                    var left = el.offsetLeft;
                    var width = el.offsetWidth;
                    var height = el.offsetHeight;

                    while (el.offsetParent) {
                        el = el.offsetParent;
                        top += el.offsetTop;
                        left += el.offsetLeft;
                    }

                    var visible = (
                        top < (window.pageYOffset + window.innerHeight) &&
                        left < (window.pageXOffset + window.innerWidth) &&
                        (top + height) > window.pageYOffset &&
                        (left + width) > window.pageXOffset
                    );

                    if (visible) {
                        polito._bacameVisible();
                    }
                };
            }
            return this._onScroll;
        }
    }
</script>
